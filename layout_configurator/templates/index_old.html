<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Modular Layout Configurator – Complete (Modern Style)</title>
  <style>
    /* Modern Base Styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    h1,
    h2,
    h3 {
      margin-top: 0;
    }

    /* Modern Configuration Panel */
    .config-panel {
      background: #fff;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .config-panel label {
      margin-right: 10px;
    }

    .config-panel input[type="number"] {
      width: 60px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .config-panel button {
      padding: 6px 12px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    .config-panel button:hover {
      background: #0056b3;
    }

    /* Modern Section Bank / Trash Zone */
    .section-bank {
      background: #fff;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .section-bank h2 {
      font-size: 1.25em;
      margin-bottom: 10px;
    }

    .section-bank .section-item {
      background: #f9f9f9;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: grab;
    }

    /* Outer Grid */
    .grid-container {
      display: grid;
      grid-gap: 10px;
      background: #fff;
      padding: 15px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .grid-cell {
      border: 1px solid #ddd;
      min-height: 150px;
      position: relative;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      background: #fafafa;
    }

    .grid-cell.over {
      border-color: #007bff;
    }

    /* Draggable Sections */
    .draggable-section {
      background: #e9f2ff;
      padding: 10px;
      border: 1px solid #80bdff;
      border-radius: 4px;
      cursor: move;
      margin-bottom: 8px;
    }

    .draggable-section.over {
      border: 2px dashed #007bff;
    }

    .dropped {}

    /* Size classes */
    .size-small {
      font-size: 16px;
    }

    /* Adjusted to 16px to match sub-widget */
    .size-medium {
      font-size: 16px;
    }

    .size-large {
      font-size: 24px;
    }

    /* Unified Sub-Widget Styling */
    .sub-widget {
      background: #fff;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin: 4px;
      cursor: move;
      display: inline-block;
      position: relative;
      text-align: left;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      font-size: 16px;
      /* Set sub-widget font size */
    }

    .sub-widget .delete-btn {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      cursor: pointer;
      z-index: 100;
    }

    /* Portfolio Container (2:1 layout) */
    .portfolio-inner {
      border: 1px dashed #ccc;
      padding: 10px;
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-radius: 4px;
      background: #f8f9fa;
    }

    .portfolio-top {
      display: flex;
      justify-content: space-between;
      border-bottom: 2px solid #ccc;
      padding-bottom: 8px;
    }

    .portfolio-top .portfolio-column {
      flex: 1;
      padding: 5px;
    }

    .portfolio-top .portfolio-column:not(:last-child) {
      margin-right: 10px;
    }

    .portfolio-top .portfolio-column:first-child {
      border-right: 1px solid #ccc;
    }

    .portfolio-bottom {
      display: block;
      text-align: left;
      border-top: 2px solid #ccc;
      padding-top: 8px;
    }

    /* Nested Grid Widget */
    .nested-grid {
      display: grid;
      grid-gap: 8px;
      background: #f1f3f5;
      padding: 10px;
      margin-top: 8px;
      border-radius: 4px;
      background: #f1f3f5;
    }

    .nested-grid-cell {
      border: 1px solid #ddd;
      min-height: 50px;
      position: relative;
      padding: 5px;
      border-radius: 4px;
      text-align: center;
      background: #fff;
    }

    .nested-grid-cell.over {
      border-color: #007bff;
    }

    /* Token Widget */
    .token-inner {
      border: 1px dashed #ccc;
      padding: 10px;
      margin-top: 8px;
      display: flex;
      flex-direction: row;
      gap: 10px;
      align-items: flex-start;
      border-radius: 4px;
      background: #f8f9fa;
    }

    /* Edit Panel */
    .edit-panel {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 15px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .edit-panel input,
    .edit-panel select {
      margin: 5px 0;
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .edit-panel button {
      padding: 8px 12px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 8px;
    }

    .edit-panel button:hover {
      background: #0056b3;
    }

    /* Management Interface List */
    .manage-list {
      list-style: none;
      padding: 0;
      margin: 0;
      text-align: left;
    }

    /* Grid Label Styling (for nested grids) */
    .grid-label {
      border: 1px solid #99f;
      padding: 5px 8px;
      cursor: move;
      position: relative;
      text-align: left;
      font-size: 16px;
      /* Same as sub-widget */
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .grid-label .delete-btn {
      top: -3px;
      right: -3px;
      width: 14px;
      height: 14px;
      font-size: 10px;
    }
  </style>
</head>

<body onload="createGrid()">
  <div class="container">
    <h1>Modular Layout Configurator – Complete</h1>
    <!-- Configuration Panel -->
    <div class="config-panel">
      <h2>Grid Settings</h2>
      <label>Grid Rows: <input type="number" id="gridRows" value="2" min="1"></label>
      <label>Grid Columns: <input type="number" id="gridCols" value="2" min="1"></label>
      <button onclick="createGrid()">Create Grid</button>
    </div>
    <!-- Section Bank / Trash Zone -->
    <div class="section-bank" id="section-bank">
      <h2>Section Bank / Trash Zone</h2>
      <div class="section-item" draggable="true"
        data-config='{"type": "portfolio", "font_size": 50, "color": "white", "size": "large", "innerWidgets": ["adabalance", "adavalue", "tokens", "lppos", "chart", "trades"]}'>
        Portfolio (Large)
      </div>
      <div class="section-item" draggable="true"
        data-config='{"type": "market_data", "font_size": 50, "color": "white", "size": "medium"}'>
        Market Data (Medium)
      </div>
      <div class="section-item" draggable="true"
        data-config='{"type": "", "font_size": 50, "color": "white", "size": "small"}'>
        Empty Section (Small)
      </div>
      <div class="section-item" draggable="true"
        data-config='{"type": "tokens", "show": ["logo", "price", "change", "chart"], "tokens": ["MIN", "SNEK", "IAG", "XER"], "font_size": 50, "color": "white", "size": "medium"}'>
        Tokens (Medium)
      </div>
      <div class="section-item" draggable="true"
        data-config='{"type": "clock", "font_size": 50, "color": "white", "size": "small"}'>
        Clock (Small)
      </div>
      <div class="section-item" draggable="true" data-config='{"type": "nested_grid", "grid_size": [2,2], "cells": []}'>
        Nested Grid (2x2)
      </div>
      <!-- New draggable item: Center Split Nested Grid -->
      <div class="section-item" draggable="true"
        data-config='{"type": "center_split", "grid_size": [1,2], "cells": []}'>
        Center Split Nested Grid
      </div>
    </div>
    <!-- Outer Grid -->
    <div id="grid-container" class="grid-container"></div>
    <!-- Edit Panel for General Properties -->
    <div id="edit-panel" class="edit-panel">
      <h2>Edit Section</h2>
      <label>Type: <input type="text" id="edit-type"></label>
      <label>Font Size: <input type="number" id="edit-font_size"></label>
      <label>Color: <input type="text" id="edit-color"></label>
      <label>Size:
        <select id="edit-size">
          <option value="small">Small</option>
          <option value="medium">Medium</option>
          <option value="large">Large</option>
        </select>
      </label>
      <button onclick="saveEdit()">Save</button>
      <button onclick="cancelEdit()">Cancel</button>
    </div>
    <!-- Export Button -->
    <button onclick="exportConfig()">Export JSON</button>
    <pre id="exported-json"></pre>
  </div>
  <script>
    // Ensure the grid is created on page load
    window.addEventListener("load", createGrid);

    let selectedSection = null;
    let gridConfig = {
      grid_size: [2, 2],
      sections: [],
      display_settings: {}
    };

    // Function: Create the outer grid
    function createGrid() {
      const rows = parseInt(document.getElementById('gridRows').value);
      const cols = parseInt(document.getElementById('gridCols').value);
      gridConfig.grid_size = [rows, cols];
      const gridContainer = document.getElementById('grid-container');
      gridContainer.innerHTML = ''; // Clear container
      gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell';
          cell.dataset.position = JSON.stringify([r, c]);
          cell.textContent = 'Drop here';
          cell.addEventListener('dragover', function (e) {
            e.preventDefault();
            this.classList.add('over');
            let source = e.dataTransfer.getData("source");
            e.dataTransfer.dropEffect = (source === "grid") ? "move" : "copy";
          });
          cell.addEventListener('dragleave', function (e) {
            this.classList.remove('over');
          });
          cell.addEventListener('drop', function (e) {
            e.preventDefault();
            this.classList.remove('over');
            let source = e.dataTransfer.getData("source");
            const configData = e.dataTransfer.getData('text/plain');
            if (source === "bank" && configData) {
              const config = JSON.parse(configData);
              addSectionToCell(this, config);
            }
          });
          gridContainer.appendChild(cell);
        }
      }
      console.log("Grid created:", rows, "rows x", cols, "cols");
    }

    // Adds a widget (section) into a grid cell
    function addSectionToCell(cell, config) {
      const sectionEl = document.createElement('div');
      sectionEl.className = 'draggable-section dropped';
      sectionEl.draggable = true;
      sectionEl.dataset.config = JSON.stringify(config);
      sectionEl.textContent = config.type || "Empty";
      if (config.size) { sectionEl.classList.add(`size-${config.size}`); }
      if (cell.textContent.trim() === 'Drop here') { cell.innerHTML = ''; }
      cell.appendChild(sectionEl);

      sectionEl.addEventListener('dragstart', function (e) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.config);
        e.dataTransfer.setData('source', 'grid');
        this.classList.add('dragging');
      });
      sectionEl.addEventListener('dragover', function (e) {
        e.preventDefault();
        this.classList.add('over');
      });
      sectionEl.addEventListener('dragleave', function (e) {
        this.classList.remove('over');
      });
      sectionEl.addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('over');
        const dragged = document.querySelector('.dragging');
        if (dragged && dragged !== this) {
          this.parentElement.insertBefore(dragged, this);
        }
      });
      sectionEl.addEventListener('dragend', function (e) {
        this.classList.remove('dragging');
      });
      sectionEl.addEventListener('dblclick', function (e) {
        selectedSection = this;
        showEditPanel(selectedSection);
      });

      if (config.type === "portfolio") {
        let portfolioContainer = document.createElement('div');
        portfolioContainer.className = 'portfolio-inner';

        let topRow = document.createElement('div');
        topRow.className = 'portfolio-top';
        topRow.style.display = "flex";
        topRow.style.justifyContent = "space-between";
        topRow.style.borderBottom = "2px solid #ccc";
        topRow.style.paddingBottom = "8px";
        let leftCol = document.createElement('div');
        leftCol.className = 'portfolio-column';
        leftCol.style.flex = "1";
        leftCol.style.marginRight = "10px";
        leftCol.style.borderRight = "1px solid #ccc";
        let rightCol = document.createElement('div');
        rightCol.className = 'portfolio-column';
        rightCol.style.flex = "1";

        let widgetLeft = document.createElement('div');
        widgetLeft.className = 'sub-widget';
        widgetLeft.textContent = "adabalance";
        addSubWidgetDragEvents(widgetLeft, leftCol);
        leftCol.appendChild(widgetLeft);
        let widgetRight = document.createElement('div');
        widgetRight.className = 'sub-widget';
        widgetRight.textContent = "adavalue";
        addSubWidgetDragEvents(widgetRight, rightCol);
        rightCol.appendChild(widgetRight);

        topRow.appendChild(leftCol);
        topRow.appendChild(rightCol);

        let bottomRow = document.createElement('div');
        bottomRow.className = 'portfolio-bottom';
        bottomRow.style.display = "flex";
        bottomRow.style.flexDirection = "column";
        bottomRow.style.alignItems = "flex-start";
        bottomRow.style.borderTop = "2px solid #ccc";
        bottomRow.style.paddingTop = "8px";
        let bottomWidgets = ["tokens", "lppos", "chart", "trades"];
        bottomWidgets.forEach(widget => {
          let widgetEl = document.createElement('div');
          widgetEl.className = 'sub-widget';
          widgetEl.textContent = widget;
          addSubWidgetDragEvents(widgetEl, bottomRow);
          bottomRow.appendChild(widgetEl);
        });

        portfolioContainer.appendChild(topRow);
        portfolioContainer.appendChild(bottomRow);
        sectionEl.appendChild(portfolioContainer);

        let manageBtn = document.createElement('button');
        manageBtn.textContent = "Edit Sub-Widgets";
        manageBtn.style.marginTop = "5px";
        manageBtn.onclick = function (e) {
          e.stopPropagation();
          openPortfolioManager(sectionEl, config, portfolioContainer);
        };
        sectionEl.appendChild(manageBtn);
      } else if (config.type === "tokens") {
        let tokenContainer = document.createElement('div');
        tokenContainer.className = 'token-inner';
        tokenContainer.style.display = "flex";
        tokenContainer.style.flexDirection = "row";
        tokenContainer.style.gap = "10px";
        let tokenWidgets = ["logo", "price", "change", "chart"];
        tokenWidgets.forEach(widget => {
          let widgetEl = document.createElement('div');
          widgetEl.className = 'sub-widget';
          widgetEl.textContent = widget;
          addSubWidgetDragEvents(widgetEl, tokenContainer);
          tokenContainer.appendChild(widgetEl);
        });
        sectionEl.appendChild(tokenContainer);

        let manageBtn = document.createElement('button');
        manageBtn.textContent = "Edit Sub-Widgets";
        manageBtn.style.marginTop = "5px";
        manageBtn.onclick = function (e) {
          e.stopPropagation();
          openTokenManager(sectionEl, config, tokenContainer);
        };
        sectionEl.appendChild(manageBtn);
      } else if (config.type === "nested_grid" || config.type === "center_split") {
        let gridElement = document.createElement('div');
        gridElement.className = 'nested-grid';
        if (config.type === "center_split") {
          gridElement.style.gridTemplateColumns = "repeat(2, 1fr)";
          for (let i = 0; i < 2; i++) {
            let cell = document.createElement('div');
            cell.className = 'nested-grid-cell';
            cell.textContent = "Drop here";
            cell.addEventListener('dragover', function (e) {
              e.preventDefault();
              e.stopPropagation();
              this.classList.add('over');
              let source = e.dataTransfer.getData("source");
              e.dataTransfer.dropEffect = (source === "bank") ? "copy" : "move";
            });
            cell.addEventListener('dragleave', function (e) {
              e.stopPropagation();
              this.classList.remove('over');
            });
            cell.addEventListener('drop', function (e) {
              e.preventDefault();
              e.stopPropagation();
              this.classList.remove('over');
              let source = e.dataTransfer.getData("source");
              const configData = e.dataTransfer.getData("text/plain");
              if (source === "bank" && configData) {
                const labelElem = document.createElement('div');
                labelElem.className = 'grid-label size-small';
                const labelConfig = JSON.parse(configData);
                labelElem.textContent = labelConfig.type || "Label";
                addGridLabelDragEvents(labelElem, this);
                this.innerHTML = "";
                this.appendChild(labelElem);
              } else {
                const dragged = document.querySelector('.dragging');
                if (dragged) {
                  this.innerHTML = "";
                  this.appendChild(dragged);
                }
              }
            });
            gridElement.appendChild(cell);
          }
        } else {
          let rows = (config.grid_size && config.grid_size[0]) ? config.grid_size[0] : 2;
          let cols = (config.grid_size && config.grid_size[1]) ? config.grid_size[1] : 2;
          gridElement.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
          for (let i = 0; i < rows * cols; i++) {
            let cell = document.createElement('div');
            cell.className = 'nested-grid-cell';
            cell.textContent = "Drop here";
            cell.addEventListener('dragover', function (e) {
              e.preventDefault();
              e.stopPropagation();
              this.classList.add('over');
              let source = e.dataTransfer.getData("source");
              e.dataTransfer.dropEffect = (source === "bank") ? "copy" : "move";
            });
            cell.addEventListener('dragleave', function (e) {
              e.stopPropagation();
              this.classList.remove('over');
            });
            cell.addEventListener('drop', function (e) {
              e.preventDefault();
              e.stopPropagation();
              this.classList.remove('over');
              let source = e.dataTransfer.getData("source");
              const configData = e.dataTransfer.getData("text/plain");
              if (source === "bank" && configData) {
                const labelElem = document.createElement('div');
                labelElem.className = 'grid-label size-small';
                const labelConfig = JSON.parse(configData);
                labelElem.textContent = labelConfig.type || "Label";
                addGridLabelDragEvents(labelElem, this);
                this.innerHTML = "";
                this.appendChild(labelElem);
              } else {
                const dragged = document.querySelector('.dragging');
                if (dragged) {
                  this.innerHTML = "";
                  this.appendChild(dragged);
                }
              }
            });
            gridElement.appendChild(cell);
          }
        }
        sectionEl.appendChild(gridElement);
      }
    }

    // Internal Drag & Drop Logic for Portfolio/Token sub-widgets (MOVE only)
    function addSubWidgetDragEvents(widgetEl, container) {
      widgetEl.draggable = true;
      widgetEl.addEventListener('dragstart', function (e) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.textContent.replace('×', '').trim());
        this.classList.add('dragging');
      });
      widgetEl.addEventListener('dragend', function (e) {
        this.classList.remove('dragging');
      });
      container.addEventListener('dragover', function (e) {
        e.preventDefault();
        container.classList.add('over');
        e.dataTransfer.dropEffect = 'move';
      });
      container.addEventListener('dragleave', function (e) {
        container.classList.remove('over');
      });
      container.addEventListener('drop', function (e) {
        e.preventDefault();
        container.classList.remove('over');
        const draggedElem = Array.from(container.children).find(child => child.classList.contains('dragging'));
        if (draggedElem) {
          container.insertBefore(draggedElem, e.target.closest('.sub-widget'));
        }
      });
      if (!widgetEl.querySelector('.delete-btn')) {
        let deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = '×';
        deleteBtn.onclick = function (e) {
          e.stopPropagation();
          widgetEl.remove();
        };
        widgetEl.appendChild(deleteBtn);
      }
    }

    // New Drag & Drop Logic for Grid Labels in Nested Grids
    function addGridLabelDragEvents(labelEl, container) {
      labelEl.draggable = true;
      let deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = '×';
      deleteBtn.onclick = function (e) {
        e.stopPropagation();
        labelEl.remove();
      };
      labelEl.appendChild(deleteBtn);
      labelEl.addEventListener('dragstart', function (e) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.textContent.replace('×', '').trim());
        this.classList.add('dragging');
      });
      labelEl.addEventListener('dragend', function (e) {
        this.classList.remove('dragging');
      });
      container.addEventListener('dragover', function (e) {
        e.preventDefault();
        container.classList.add('over');
        e.dataTransfer.dropEffect = 'move';
      });
      container.addEventListener('dragleave', function (e) {
        container.classList.remove('over');
      });
      container.addEventListener('drop', function (e) {
        e.preventDefault();
        container.classList.remove('over');
        const draggedElem = Array.from(container.children).find(child => child.classList.contains('dragging'));
        if (draggedElem) {
          container.insertBefore(draggedElem, e.target.closest('.grid-label'));
        }
      });
    }

    // Global function: Open the management interface for Portfolio sub-widgets
    function openPortfolioManager(sectionEl, config, portfolioContainer) {
      if (sectionEl.querySelector('.portfolio-manager')) return;
      let managerPanel = document.createElement('div');
      managerPanel.className = 'portfolio-manager';
      managerPanel.innerHTML = "<h3>Manage Sub-Widgets</h3>";
      let ul = document.createElement('ul');
      ul.className = "manage-list";
      const allPortfolioWidgets = ["adabalance", "adavalue", "tokens", "lppos", "chart", "trades"];
      allPortfolioWidgets.forEach(widget => {
        let li = document.createElement('li');
        li.draggable = true;
        li.textContent = widget;
        let checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.checked = config.innerWidgets && config.innerWidgets.includes(widget);
        li.prepend(checkbox);
        li.addEventListener('dragstart', function (e) {
          e.dataTransfer.setData('text/plain', widget);
          li.classList.add('dragging');
        });
        li.addEventListener('dragend', function (e) {
          li.classList.remove('dragging');
        });
        li.addEventListener('dragover', function (e) {
          e.preventDefault();
          li.classList.add('over');
        });
        li.addEventListener('dragleave', function (e) {
          li.classList.remove('over');
        });
        li.addEventListener('drop', function (e) {
          e.preventDefault();
          li.classList.remove('over');
          let draggedWidget = e.dataTransfer.getData('text/plain');
          li.textContent = draggedWidget;
          li.prepend(checkbox);
        });
        ul.appendChild(li);
      });
      managerPanel.appendChild(ul);
      let saveBtn = document.createElement('button');
      saveBtn.textContent = "Save Sub-Widget Settings";
      saveBtn.onclick = function (e) {
        let newOrder = [];
        ul.querySelectorAll("li").forEach(li => {
          let widgetName = li.textContent.trim();
          let cb = li.querySelector("input[type='checkbox']");
          if (cb && cb.checked) {
            newOrder.push(widgetName);
          }
        });
        config.innerWidgets = newOrder;
        let newContainer = document.createElement('div');
        newContainer.className = 'portfolio-inner';
        let topRow = document.createElement('div');
        topRow.className = 'portfolio-top';
        topRow.style.display = "flex";
        topRow.style.justifyContent = "space-between";
        let leftCol = document.createElement('div');
        leftCol.className = 'portfolio-column';
        leftCol.style.flex = "1";
        leftCol.style.marginRight = "10px";
        let rightCol = document.createElement('div');
        rightCol.className = 'portfolio-column';
        rightCol.style.flex = "1";
        let topWidgets = ["adabalance", "adavalue"];
        topWidgets.forEach(widget => {
          if (newOrder.includes(widget)) {
            let widgetEl = document.createElement('div');
            widgetEl.className = 'sub-widget';
            widgetEl.textContent = widget;
            addSubWidgetDragEvents(widgetEl, leftCol);
            leftCol.appendChild(widgetEl);
          }
        });
        topRow.appendChild(leftCol);
        topRow.appendChild(rightCol);
        let bottomRow = document.createElement('div');
        bottomRow.className = 'portfolio-bottom';
        bottomRow.style.display = "flex";
        bottomRow.style.flexDirection = "column";
        bottomRow.style.alignItems = "flex-start";
        let remaining = newOrder.filter(w => !topWidgets.includes(w));
        remaining.forEach(widget => {
          let widgetEl = document.createElement('div');
          widgetEl.className = 'sub-widget';
          widgetEl.textContent = widget;
          addSubWidgetDragEvents(widgetEl, bottomRow);
          bottomRow.appendChild(widgetEl);
        });
        newContainer.appendChild(topRow);
        newContainer.appendChild(bottomRow);
        let oldContainer = sectionEl.querySelector('.portfolio-inner');
        if (oldContainer) { oldContainer.remove(); }
        sectionEl.insertBefore(newContainer, sectionEl.querySelector('button'));
        managerPanel.remove();
        sectionEl.dataset.config = JSON.stringify(config);
      };
      let cancelBtn = document.createElement('button');
      cancelBtn.textContent = "Cancel";
      cancelBtn.onclick = function (e) {
        managerPanel.remove();
      };
      managerPanel.appendChild(saveBtn);
      managerPanel.appendChild(cancelBtn);
      sectionEl.appendChild(managerPanel);
    }

    // Global function: Open the management interface for Token sub-widgets (including tickers)
    function openTokenManager(sectionEl, config, tokenContainer) {
      if (sectionEl.querySelector('.token-manager')) return;
      let managerPanel = document.createElement('div');
      managerPanel.className = 'token-manager';
      managerPanel.innerHTML = "<h3>Manage Token Sub-Widgets</h3>";
      let ul = document.createElement('ul');
      ul.className = "manage-list";
      const allTokenWidgets = ["logo", "price", "change", "chart"];
      allTokenWidgets.forEach(widget => {
        let li = document.createElement('li');
        li.draggable = true;
        li.textContent = widget;
        let checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.checked = config.innerWidgets && config.innerWidgets.includes(widget);
        li.prepend(checkbox);
        li.addEventListener('dragstart', function (e) {
          e.dataTransfer.setData('text/plain', widget);
          li.classList.add('dragging');
        });
        li.addEventListener('dragend', function (e) {
          li.classList.remove('dragging');
        });
        li.addEventListener('dragover', function (e) {
          e.preventDefault();
          li.classList.add('over');
        });
        li.addEventListener('dragleave', function (e) {
          li.classList.remove('over');
        });
        li.addEventListener('drop', function (e) {
          e.preventDefault();
          li.classList.remove('over');
          let draggedWidget = e.dataTransfer.getData('text/plain');
          li.textContent = draggedWidget;
          li.prepend(checkbox);
        });
        ul.appendChild(li);
      });
      managerPanel.appendChild(ul);
      // Input for Tickers – stored in config.tokens (not rendered)
      let tickerDiv = document.createElement('div');
      tickerDiv.style.marginTop = "10px";
      let tickerLabel = document.createElement('label');
      tickerLabel.textContent = "Tickers (comma separated):";
      let tickerInput = document.createElement('input');
      tickerInput.type = "text";
      tickerInput.style.width = "100%";
      tickerInput.style.marginTop = "5px";
      if (config.tokens && Array.isArray(config.tokens)) {
        tickerInput.value = config.tokens.join(", ");
      }
      tickerDiv.appendChild(tickerLabel);
      tickerDiv.appendChild(tickerInput);
      managerPanel.appendChild(tickerDiv);
      let saveBtn = document.createElement('button');
      saveBtn.textContent = "Save Sub-Widget Settings";
      saveBtn.onclick = function (e) {
        let newOrder = [];
        ul.querySelectorAll("li").forEach(li => {
          let widgetName = li.textContent.trim();
          let cb = li.querySelector("input[type='checkbox']");
          if (cb && cb.checked) {
            newOrder.push(widgetName);
          }
        });
        config.innerWidgets = newOrder;
        if (tickerInput.value.trim() !== "") {
          config.tokens = tickerInput.value.split(",").map(t => t.trim());
        } else {
          config.tokens = [];
        }
        let newContainer = document.createElement('div');
        newContainer.className = 'token-inner';
        newContainer.style.display = "flex";
        newContainer.style.flexDirection = "row";
        newContainer.style.gap = "10px";
        let tokenWidgets = ["logo", "price", "change", "chart"];
        tokenWidgets.forEach(widget => {
          if (newOrder.includes(widget)) {
            let widgetEl = document.createElement('div');
            widgetEl.className = 'sub-widget';
            widgetEl.textContent = widget;
            addSubWidgetDragEvents(widgetEl, newContainer);
            newContainer.appendChild(widgetEl);
          }
        });
        let oldContainer = sectionEl.querySelector('.token-inner');
        if (oldContainer) { oldContainer.remove(); }
        sectionEl.insertBefore(newContainer, sectionEl.querySelector('button'));
        managerPanel.remove();
        sectionEl.dataset.config = JSON.stringify(config);
      };
      let cancelBtn = document.createElement('button');
      cancelBtn.textContent = "Cancel";
      cancelBtn.onclick = function (e) {
        managerPanel.remove();
      };
      managerPanel.appendChild(saveBtn);
      managerPanel.appendChild(cancelBtn);
      sectionEl.appendChild(managerPanel);
    }

    // Edit Panel for General Properties
    function showEditPanel(sectionEl) {
      const config = JSON.parse(sectionEl.dataset.config);
      document.getElementById('edit-type').value = config.type || "";
      document.getElementById('edit-font_size').value = config.font_size || "";
      document.getElementById('edit-color').value = config.color || "";
      document.getElementById('edit-size').value = config.size || "medium";
      document.getElementById('edit-panel').style.display = 'block';
    }
    function saveEdit() {
      if (!selectedSection) return;
      const config = JSON.parse(selectedSection.dataset.config);
      config.type = document.getElementById('edit-type').value;
      config.font_size = parseInt(document.getElementById('edit-font_size').value);
      config.color = document.getElementById('edit-color').value;
      config.size = document.getElementById('edit-size').value;
      selectedSection.dataset.config = JSON.stringify(config);
      selectedSection.textContent = config.type || "Empty";
      if (config.type === "portfolio") {
        const portfolioContainer = selectedSection.querySelector('.portfolio-inner');
        if (portfolioContainer) {
          selectedSection.appendChild(portfolioContainer);
        }
      }
      document.getElementById('edit-panel').style.display = 'none';
    }
    function cancelEdit() {
      document.getElementById('edit-panel').style.display = 'none';
      selectedSection = null;
    }

    // Trash Zone: The Section Bank serves as the trash zone – widgets already in the grid are removed when dropped here.
    const sectionBankEl = document.getElementById('section-bank');
    sectionBankEl.addEventListener('dragover', function (e) {
      e.preventDefault();
      this.classList.add('over');
      e.dataTransfer.dropEffect = 'move';
    });
    sectionBankEl.addEventListener('dragleave', function (e) {
      this.classList.remove('over');
    });
    sectionBankEl.addEventListener('drop', function (e) {
      e.preventDefault();
      this.classList.remove('over');
      const dragged = document.querySelector('.dragging');
      if (dragged && dragged.classList.contains('dropped')) {
        dragged.remove();
      }
    });

    // Drag & Drop for Section Bank items (prototypes)
    document.querySelectorAll('.section-bank .section-item').forEach(item => {
      item.addEventListener('dragstart', function (e) {
        e.dataTransfer.setData('text/plain', this.dataset.config);
        e.dataTransfer.setData('source', 'bank');
        this.classList.add('dragging');
      });
      item.addEventListener('dragend', function () {
        this.classList.remove('dragging');
      });
    });

    // Exports the configuration as JSON (including sub-widgets)
    function exportConfig() {
      const gridContainer = document.getElementById('grid-container');
      const cells = gridContainer.querySelectorAll('.grid-cell');
      const sections = [];
      cells.forEach(cell => {
        const cellSections = cell.querySelectorAll('.draggable-section');
        cellSections.forEach(section => {
          const config = JSON.parse(section.dataset.config);
          const position = JSON.parse(cell.dataset.position);
          if (config.type === "portfolio") {
            const portfolioContainer = section.querySelector('.portfolio-inner');
            if (portfolioContainer) {
              let widgets = [];
              Array.from(portfolioContainer.querySelectorAll('.sub-widget')).forEach(child => {
                widgets.push(child.childNodes[0] ? child.childNodes[0].nodeValue.trim() : "");
              });
              config.innerWidgets = widgets;
            }
          }
          if (config.type === "tokens") {
            const tokenContainer = section.querySelector('.token-inner');
            if (tokenContainer) {
              let widgets = [];
              Array.from(tokenContainer.querySelectorAll('.sub-widget')).forEach(child => {
                widgets.push(child.childNodes[0] ? child.childNodes[0].nodeValue.trim() : "");
              });
              config.innerWidgets = widgets;
            }
          }
          if (config.type === "nested_grid" || config.type === "center_split") {
            const gridElement = section.querySelector('.nested-grid');
            if (gridElement) {
              let cellsArr = [];
              Array.from(gridElement.children).forEach(cell => {
                let labelElem = cell.querySelector('.grid-label');
                cellsArr.push(labelElem ? labelElem.childNodes[0].nodeValue.trim() : "");
              });
              config.cells = cellsArr;
            }
          }
          config.position = position;
          sections.push(config);
        });
      });
      gridConfig.sections = sections;
      const output = JSON.stringify(gridConfig, null, 4);
      document.getElementById('exported-json').textContent = output;
    }

    // Create the grid on page load
    createGrid();
  </script>
  <!-- Separate Edit Panel -->
  <div id="edit-panel" class="edit-panel">
    <h2>Edit Section</h2>
    <label>Type: <input type="text" id="edit-type"></label>
    <label>Font Size: <input type="number" id="edit-font_size"></label>
    <label>Color: <input type="text" id="edit-color"></label>
    <label>Size:
      <select id="edit-size">
        <option value="small">Small</option>
        <option value="medium">Medium</option>
        <option value="large">Large</option>
      </select>
    </label>
    <button onclick="saveEdit()">Save</button>
    <button onclick="cancelEdit()">Cancel</button>
  </div>
</body>

</html>